<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOLT Connect - Prototype v0.2</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        /* Thanh ƒëi·ªÅu khi·ªÉn b·ªô l·ªçc */
        .filter-controls {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            display: flex;
            gap: 5px;
        }
        .filter-btn {
            padding: 10px 15px;
            font-size: 16px;
            font-weight: 600;
            border: 2px solid #007bff;
            background-color: #f0f8ff;
            color: #007bff;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .filter-btn:hover, .filter-btn.active {
            background-color: #007bff;
            color: white;
        }
        #status-bar {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 15px;
            border-radius: 10px;
            z-index: 1000;
            font-size: 14px;
        }
    </style>
</head>
<body>

    <div id="map"></div>
    
    <div class="filter-controls" id="controls">
        <button class="filter-btn active" data-loai="xang_dau">‚õΩÔ∏è XƒÉng</button>
        <button class="filter-btn" data-loai="tram_sac">‚ö°Ô∏è S·∫°c</button>
        <button class="filter-btn" data-loai="sua_chua">üõ†Ô∏è S·ª≠a</button>
    </div>
    
    <div id="status-bar">ƒêang t√¨m v·ªã tr√≠ c·ªßa b·∫°n...</div>

    <script>
        // --- C·∫§U H√åNH ---
        const API_URL_BASE = 'http://127.0.0.1:8000';
        const DEFAULT_LAT = 10.7798;
        const DEFAULT_LON = 106.7020;
        const DEFAULT_ZOOM = 15;
        const SEARCH_RADIUS_KM = 3.0; // TƒÉng b√°n k√≠nh t√¨m ki·∫øm l√™n 3km

        // Bi·∫øn to√†n c·ª•c ƒë·ªÉ qu·∫£n l√Ω b·∫£n ƒë·ªì v√† ghim
        let map;
        let userMarker;
        let currentLat = DEFAULT_LAT;
        let currentLon = DEFAULT_LON;
        let activeFilter = 'xang_dau'; // B·ªô l·ªçc m·∫∑c ƒë·ªãnh
        const pinLayer = L.layerGroup(); // Layer ƒë·ªÉ ch·ª©a c√°c ghim
        const statusBar = document.getElementById('status-bar');

        // --- 1. KH·ªûI T·∫†O B·∫¢N ƒê·ªí ---
        function initMap(lat, lon) {
            map = L.map('map').setView([lat, lon], DEFAULT_ZOOM);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Th√™m layer ghim v√†o b·∫£n ƒë·ªì
            pinLayer.addTo(map);

            // ƒê√°nh d·∫•u v·ªã tr√≠ ng∆∞·ªùi d√πng
            userMarker = L.circleMarker([lat, lon], {
                color: '#007bff', fillColor: '#007bff', fillOpacity: 0.8, radius: 8
            }).addTo(map).bindPopup(
                `<b>V·ªã tr√≠ c·ªßa b·∫°n</b><br>` +
                `Vƒ© ƒë·ªô: <b>${lat.toFixed(5)}</b><br>` +`Kinh ƒë·ªô: <b>${lon.toFixed(5)}</b>`
            );
        }

        // --- 2. G·ªåI API V√Ä V·∫º GHIM ---
        async function fetchAndDrawPins(lat, lon, loai_diem) {
            statusBar.textContent = `ƒêang t√¨m "${loai_diem}" xung quanh b·∫°n...`;
            
            // X√≥a c√°c ghim c≈©
            pinLayer.clearLayers();

            const params = new URLSearchParams({
                'vi_do': lat,
                'kinh_do': lon,
                'ban_kinh_km': SEARCH_RADIUS_KM,
                'loai_diem': loai_diem
            });
            const url = `${API_URL_BASE}/cac-diem-xung-quanh?${params.toString()}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const danhSachDiem = await response.json();

                // L·∫∑p qua k·∫øt qu·∫£ v√† v·∫Ω ghim
                danhSachDiem.forEach(diem => {
                    const marker = L.marker([diem.vi_do, diem.kinh_do]);
                    marker.bindPopup(
                        `<b>${diem.ten}</b> (ID: ${diem.id})<br>` +
                        `${diem.dia_chi || 'Kh√¥ng c√≥ ƒë·ªãa ch·ªâ'}<br>` +
                        `Lo·∫°i: ${diem.loai}<br>` +
                        `<b>C√°ch: ${diem.khoang_cach_km} km</b>`
                    );
                    pinLayer.addLayer(marker); // Th√™m ghim v√†o layer
                });

                statusBar.textContent = `T√¨m th·∫•y ${danhSachDiem.length} ƒëi·ªÉm "${loai_diem}".`;

            } catch (error) {
                console.error("L·ªói khi g·ªçi API:", error);
                statusBar.textContent = 'L·ªói khi t·∫£i d·ªØ li·ªáu API!';
            }
        }

        // --- 3. X·ª¨ L√ù N√öT B·∫§M L·ªåC ---
        const controlButtons = document.querySelectorAll('.filter-btn');
        controlButtons.forEach(button => {
            button.addEventListener('click', () => {
                // B·ªè active t·∫•t c·∫£ c√°c n√∫t
                controlButtons.forEach(btn => btn.classList.remove('active'));
                // Active n√∫t ƒë∆∞·ª£c ch·ªçn
                button.classList.add('active');
                
                activeFilter = button.dataset.loai;
                
                // G·ªçi l·∫°i API v·ªõi b·ªô l·ªçc m·ªõi (t·∫°i v·ªã tr√≠ hi·ªán t·∫°i)
                fetchAndDrawPins(currentLat, currentLon, activeFilter);
            });
        });

        // --- 4. H√ÄM CH·∫†Y CH√çNH (KH·ªûI ƒê·ªòNG) ---
        function main() {
            if (!navigator.geolocation) {
                statusBar.textContent = "Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ GPS. D√πng v·ªã tr√≠ m·∫∑c ƒë·ªãnh.";
                initMap(DEFAULT_LAT, DEFAULT_LON);
                fetchAndDrawPins(DEFAULT_LAT, DEFAULT_LON, activeFilter);
                return;
            }

            statusBar.textContent = "ƒêang xin quy·ªÅn truy c·∫≠p v·ªã tr√≠...";
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // TH√ÄNH C√îNG: L·∫•y ƒë∆∞·ª£c v·ªã tr√≠ GPS
                    currentLat = position.coords.latitude;
                    currentLon = position.coords.longitude;
                    
                    statusBar.textContent = `V·ªã tr√≠: ${currentLat.toFixed(5)}, ${currentLon.toFixed(5)}. ƒêang t·∫£i...`;
                    
                    initMap(currentLat, currentLon);
                    fetchAndDrawPins(currentLat, currentLon, activeFilter);
                },
                (error) => {
                    // TH·∫§T B·∫†I: Ng∆∞·ªùi d√πng t·ª´ ch·ªëi ho·∫∑c c√≥ l·ªói
                    console.warn(`L·ªói GPS (Code ${error.code}): ${error.message}`);
                    statusBar.textContent = "L·ªói GPS. D√πng v·ªã tr√≠ m·∫∑c ƒë·ªãnh.";
                    
                    initMap(DEFAULT_LAT, DEFAULT_LON);
                    fetchAndDrawPins(DEFAULT_LAT, DEFAULT_LON, activeFilter);
                }
            );
        }

        // Ch·∫°y
        main();

    </script>

</body>
</html>
